<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-900 dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat with Your Documents</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
      }
      .message-container::-webkit-scrollbar {
        width: 8px;
      }
      .message-container::-webkit-scrollbar-track {
        background: #374151;
      }
      .message-container::-webkit-scrollbar-thumb {
        background: #6b7280;
        border-radius: 4px;
      }
      .message-container::-webkit-scrollbar-thumb:hover {
        background: #9ca3af;
      }
    </style>
  </head>
  <body class="h-full flex items-center justify-center p-4 bg-gray-900">
    <div
      class="bg-gray-800 rounded-2xl shadow-xl w-full max-w-4xl h-full max-h-[800px] flex flex-col overflow-hidden border border-gray-700"
    >
      <div
        class="bg-gray-900 text-white p-4 flex items-center justify-between rounded-t-2xl border-b border-gray-700"
      >
        <h1 class="text-2xl font-bold">Document Q&A Bot</h1>
        <div class="flex items-center space-x-2">
          <button
            id="clear-memory-btn"
            class="text-gray-400 hover:text-white transition-colors duration-200"
            title="Clear Chat History"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke-width="2"
              stroke="currentColor"
              class="w-6 h-6"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.166L15.42 1.942a2.25 2.25 0 00-2.147-1.528H9.76a2.25 2.25 0 00-2.147 1.528L4.242 5.794a2.25 2.25 0 00-1.84 2.288l1.71 11.235A2.25 2.25 0 005.9 22.5h12.2c1.033 0 1.9-.84 1.948-1.865l1.71-11.235a2.25 2.25 0 00-1.84-2.288z"
              />
            </svg>
          </button>
          <a
            href="/"
            class="text-gray-400 hover:text-white transition-colors duration-200"
            title="Go back"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke-width="2"
              stroke="currentColor"
              class="w-6 h-6"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M9 15L3 9m0 0l6-6M3 9h12a6 6 0 010 12h-3"
              />
            </svg>
          </a>
        </div>
      </div>

      <div
        id="chat-messages"
        class="flex-grow p-4 overflow-y-auto message-container space-y-4 bg-gray-800"
      >
        <div class="flex justify-start">
          <div class="bg-gray-700 p-4 rounded-lg max-w-lg border border-gray-600">
            <p class="text-gray-200">
              Hello! I'm ready to answer questions about your uploaded
              documents. What would you like to ask?
            </p>
          </div>
        </div>
      </div>

      <form
        id="chat-form"
        class="p-4 border-t border-gray-700 flex items-end space-x-2 bg-gray-800"
      >
        <textarea
          id="question-input"
          rows="1"
          placeholder="Type your question here..."
          class="flex-grow p-3 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 resize-none overflow-hidden bg-gray-700 text-gray-200 placeholder-gray-400"
        ></textarea>
        <button
          type="submit"
          class="bg-purple-600 text-white rounded-lg p-3 w-12 h-12 flex items-center justify-center transition-colors duration-200 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="2"
            stroke="currentColor"
            class="w-6 h-6"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5"
            />
          </svg>
        </button>
      </form>
    </div>

    <script>
      const chatForm = document.getElementById("chat-form");
      const questionInput = document.getElementById("question-input");
      const chatMessages = document.getElementById("chat-messages");
      const clearMemoryBtn = document.getElementById("clear-memory-btn");

      // Function to create and append a message element
      function addMessage(text, isUser = false) {
        const messageDiv = document.createElement("div");
        messageDiv.classList.add(
          "flex",
          isUser ? "justify-end" : "justify-start"
        );

        const textContainer = document.createElement("div");
        textContainer.classList.add("p-4", "rounded-lg", "max-w-lg");
        textContainer.classList.add(isUser ? "bg-purple-600" : "bg-gray-700");
        textContainer.classList.add(isUser ? "text-white" : "text-gray-200");
        textContainer.classList.add("border", "border-gray-600");

        // Handle markdown formatting, links, and line breaks from the backend
        let formattedText = text
          // Convert markdown links [text](url) to HTML links
          .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" class="text-purple-400 hover:text-purple-300 underline" target="_blank">$1</a>')
          // Convert line breaks
          .replace(/\n/g, "<br>");
        
        textContainer.innerHTML = formattedText;

        messageDiv.appendChild(textContainer);
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight; // Scroll to bottom
      }

      // Handle form submission
      chatForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const question = questionInput.value.trim();

        if (!question) {
          return;
        }

        // Add user's message to the chat
        addMessage(question, true);
        questionInput.value = "";

        // Show a "typing" indicator
        const loadingIndicator = document.createElement("div");
        loadingIndicator.innerHTML = `
          <div class="flex justify-start">
            <div class="bg-gray-700 p-4 rounded-lg max-w-lg border border-gray-600">
              <div class="flex space-x-1">
                <span class="dot-flashing bg-gray-400 w-2 h-2 rounded-full animate-bounce" style="animation-delay: 0s;"></span>
                <span class="dot-flashing bg-gray-400 w-2 h-2 rounded-full animate-bounce" style="animation-delay: 0.2s;"></span>
                <span class="dot-flashing bg-gray-400 w-2 h-2 rounded-full animate-bounce" style="animation-delay: 0.4s;"></span>
              </div>
            </div>
          </div>`;
        chatMessages.appendChild(loadingIndicator);
        chatMessages.scrollTop = chatMessages.scrollHeight;

        try {
          const response = await fetch("/ask", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ question: question }),
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();
          chatMessages.removeChild(loadingIndicator); // Remove loading indicator
          addMessage(data.response);
        } catch (error) {
          console.error("Error:", error);
          chatMessages.removeChild(loadingIndicator);
          addMessage(
            "Sorry, I'm having trouble connecting. Please try again later."
          );
        }
      });

      // Handle clear memory button click
      clearMemoryBtn.addEventListener("click", async () => {
        if (confirm("Are you sure you want to clear the chat history?")) {
          try {
            const response = await fetch("/clear-memory", {
              method: "POST",
            });
            const data = await response.json();
            if (data.status === "Memory cleared successfully") {
              // Clear the chat messages from the UI
              chatMessages.innerHTML = `
                <div class="flex justify-start">
                  <div class="bg-gray-700 p-4 rounded-lg max-w-lg border border-gray-600">
                    <p class="text-gray-200">
                      Hello! I'm ready to answer questions about your uploaded
                      documents. What would you like to ask?
                    </p>
                  </div>
                </div>
              `;
              addMessage("Chat history cleared!", false); // Add a confirmation message
            }
          } catch (error) {
            console.error("Error clearing memory:", error);
            addMessage("Failed to clear chat history.", false);
          }
        }
      });

      // Auto-resize the textarea
      questionInput.addEventListener("input", () => {
        questionInput.style.height = "auto";
        questionInput.style.height = questionInput.scrollHeight + "px";
      });
    </script>
  </body>
</html>
